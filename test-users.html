<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Sync</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .user-list { background: white; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .user-item { padding: 5px; border-bottom: 1px solid #eee; }
        .user-item:last-child { border-bottom: none; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>User Sync Test</h1>
        
        <div class="test-section">
            <h2>Firebase Connection Test</h2>
            <button onclick="testConnection()">Test Firebase Connection</button>
            <div id="connectionResult"></div>
        </div>
        
        <div class="test-section">
            <h2>User Management Test</h2>
            <button onclick="loadAllUsers()">Load All Users</button>
            <button onclick="createTestUser()">Create Test User</button>
            <div id="userResult"></div>
            <div class="user-list" id="userList"></div>
        </div>
        
        <div class="test-section">
            <h2>Create User</h2>
            <input type="text" id="username" placeholder="Username" value="testuser1">
            <input type="text" id="password" placeholder="Password" value="testpass123">
            <input type="email" id="email" placeholder="Email" value="test@example.com">
            <br>
            <button onclick="createUser()">Create User</button>
            <div id="createResult"></div>
        </div>
        
        <div class="test-section">
            <h2>Console Logs</h2>
            <p>Open browser console (F12) to see detailed logs</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration and User Management -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-user-management.js"></script>

    <script>
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const resultDiv = document.getElementById('connectionResult');
            if (resultDiv) {
                const div = document.createElement('div');
                div.className = type;
                div.textContent = message;
                resultDiv.appendChild(div);
            }
        }

        async function testConnection() {
            log('Testing Firebase connection...', 'info');
            
            try {
                // Test Firebase SDK
                if (typeof firebase === 'undefined') {
                    log('❌ Firebase SDK not loaded', 'error');
                    return;
                }
                log('✅ Firebase SDK loaded', 'success');
                
                // Test Firebase initialization
                if (!window.firebaseDB || !window.firebaseAuth) {
                    log('❌ Firebase not initialized', 'error');
                    return;
                }
                log('✅ Firebase initialized', 'success');
                log(`Project ID: ${firebase.app().options.projectId}`, 'info');
                
                // Test database connection
                const testDoc = await window.firebaseDB.collection('test').doc('connection').get();
                log('✅ Database connection successful', 'success');
                
                // Test user management
                if (!window.firebaseUserManagement) {
                    log('❌ Firebase User Management not available', 'error');
                    return;
                }
                log('✅ Firebase User Management available', 'success');
                
            } catch (error) {
                log(`❌ Connection test failed: ${error.message}`, 'error');
            }
        }

        async function loadAllUsers() {
            log('Loading all users...', 'info');
            
            try {
                if (!window.firebaseUserManagement) {
                    log('❌ Firebase User Management not available', 'error');
                    return;
                }
                
                const result = await window.firebaseUserManagement.getAllUsers();
                log(`✅ Get users result: success=${result.success}`, 'success');
                
                if (result.success) {
                    log(`Found ${result.users.length} users`, 'info');
                    displayUsers(result.users);
                } else {
                    log(`❌ Failed to get users: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`❌ Error loading users: ${error.message}`, 'error');
            }
        }

        function displayUsers(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            if (users.length === 0) {
                userList.innerHTML = '<div class="user-item">No users found</div>';
                return;
            }
            
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `
                    <strong>${user.username}</strong> 
                    (${user.email || 'no email'}) 
                    - Role: ${user.role || 'student'}
                    <button onclick="deleteUser('${user.username}')" style="float: right; background: #dc3545; padding: 2px 8px; font-size: 12px;">Delete</button>
                `;
                userList.appendChild(div);
            });
        }

        async function createTestUser() {
            const username = 'testuser_' + Date.now();
            const userData = {
                username: username,
                password: 'test123',
                email: 'test@example.com',
                fullName: 'Test User',
                role: 'student'
            };
            
            log(`Creating test user: ${username}`, 'info');
            
            try {
                const result = await window.firebaseUserManagement.createUser(userData);
                if (result.success) {
                    log(`✅ Test user created successfully: ${username}`, 'success');
                    loadAllUsers(); // Refresh the list
                } else {
                    log(`❌ Failed to create test user: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Error creating test user: ${error.message}`, 'error');
            }
        }

        async function createUser() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!username || !password) {
                log('Please enter username and password', 'error');
                return;
            }
            
            const userData = {
                username: username,
                password: password,
                email: email,
                fullName: username,
                role: 'student'
            };
            
            log(`Creating user: ${username}`, 'info');
            
            try {
                const result = await window.firebaseUserManagement.createUser(userData);
                if (result.success) {
                    log(`✅ User created successfully: ${username}`, 'success');
                    document.getElementById('createResult').innerHTML = `<div class="success">User created successfully!</div>`;
                    loadAllUsers(); // Refresh the list
                } else {
                    log(`❌ Failed to create user: ${result.error}`, 'error');
                    document.getElementById('createResult').innerHTML = `<div class="error">Failed to create user: ${result.error}</div>`;
                }
            } catch (error) {
                log(`❌ Error creating user: ${error.message}`, 'error');
                document.getElementById('createResult').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }
            
            log(`Deleting user: ${username}`, 'info');
            
            try {
                const result = await window.firebaseUserManagement.deleteUser(username);
                if (result.success) {
                    log(`✅ User deleted successfully: ${username}`, 'success');
                    loadAllUsers(); // Refresh the list
                } else {
                    log(`❌ Failed to delete user: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Error deleting user: ${error.message}`, 'error');
            }
        }

        // Auto-run connection test when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded. Testing Firebase connection...', 'info');
            testConnection();
        });
    </script>
</body>
</html>
