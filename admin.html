<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Admin - Prime Team Platform</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5" id="adminApp">
        <h1 class="mb-4">Admin</h1>
        <div id="adminLogin">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Admin Login</h5>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label for="adminUser">Username</label>
                            <input type="text" class="form-control" id="adminUser" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label for="adminPass">Passcode</label>
                            <input type="password" class="form-control" id="adminPass" placeholder="Enter password">
                        </div>
                        <div id="adminLoginError" class="text-danger mb-2" style="display:none"></div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="adminPanel" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">User Management</h5>
                <div>
                    <button id="logoutAdmin" class="btn btn-outline-secondary btn-sm">Logout</button>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <form id="userForm" class="form-inline">
                        <div class="form-group mr-2 mb-2">
                            <label for="uName" class="mr-2">Username</label>
                            <input type="text" class="form-control" id="uName" placeholder="username">
                        </div>
                        <div class="form-group mr-2 mb-2">
                            <label for="uPass" class="mr-2">Password</label>
                            <input type="text" class="form-control" id="uPass" placeholder="password">
                        </div>
                        <button type="submit" class="btn btn-success mb-2">Add / Update</button>
                        <div id="userFormMsg" class="ml-3 text-danger mb-2" style="display:none"></div>
                    </form>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="card-title">Course-Specific User Activation</h6>
                    <form id="courseActivationForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="activateUser">Select User</label>
                                <select class="form-control" id="activateUser">
                                    <option value="">Choose a user...</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="activateCourse">Select Course</label>
                                <select class="form-control" id="activateCourse">
                                    <option value="">Choose a course...</option>
                                    <option value="math-est-1">Math Course EST 1</option>
                                    <option value="math-est-2">Math Course EST 2</option>
                                    <option value="english-est-1">English Course EST 1</option>
                                    <option value="biology-est-1">Biology Course EST 1</option>
                                    <option value="biology-est-2">Biology Course EST 2</option>
                                    <option value="chemistry-est-2">Chemistry Course EST 2</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="activationDays">Duration (Days)</label>
                                <input type="number" class="form-control" id="activationDays" placeholder="30" min="1" max="365" value="30">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Activate Course Access</button>
                                <div id="activationMsg" class="mt-2" style="display:none"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Video Management Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="card-title">Video Management</h6>
                    <form id="videoManagementForm">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="videoCourse">Select Course</label>
                                <select class="form-control" id="videoCourse">
                                    <option value="">Choose a course...</option>
                                    <option value="math-est-1">Math Course EST 1</option>
                                    <option value="math-est-2">Math Course EST 2</option>
                                    <option value="english-est-1">English Course EST 1</option>
                                    <option value="biology-est-1">Biology Course EST 1</option>
                                    <option value="biology-est-2">Biology Course EST 2</option>
                                    <option value="chemistry-est-2">Chemistry Course EST 2</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="videoKey">Video Key</label>
                                <input type="text" class="form-control" id="videoKey" placeholder="e.g., linear-equations">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="videoUrl">Google Drive Video URL</label>
                                <input type="url" class="form-control" id="videoUrl" placeholder="https://drive.google.com/file/d/VIDEO_ID/preview">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Update Video URL</button>
                                <button type="button" class="btn btn-info ml-2" id="loadVideosBtn">Load Course Videos</button>
                                <div id="videoMsg" class="mt-2" style="display:none"></div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Video List Display -->
                    <div id="videoList" class="mt-4" style="display:none">
                        <h6>Current Videos for <span id="currentCourseName"></span></h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="videosTable">
                                <thead>
                                    <tr>
                                        <th>Video Key</th>
                                        <th>URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">All Users</h6>
                    <div class="table-responsive">
                        <table class="table table-sm" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Math EST 1</th>
                                    <th>Math EST 2</th>
                                    <th>English EST 1</th>
                                    <th>Biology EST 1</th>
                                    <th>Biology EST 2</th>
                                    <th>Chemistry EST 2</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration and Course Access -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-course-access.js"></script>
    <script src="js/firebase-user-management.js"></script>
    
    <script>
    (function(){
        // Firebase-based user management
        var adminKey = 'ptp_admin_logged_in';
        
        // Simple hash function for basic obfuscation
        function simpleHash(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                var char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }
        
        // Obfuscated credentials (in production, use server-side authentication)
        var ADMIN_USER = atob('SEFNT0tTSEFfMDE='); // Base64 encoded 'HAMOKSHA_01'
        var ADMIN_PASS = atob('MTU5NzUz'); // Base64 encoded '159753'

        // Firebase-based user management functions
        async function loadUsers(){
            console.log('loadUsers called, firebaseUserManagement available:', !!window.firebaseUserManagement);
            if (window.firebaseUserManagement) {
                try {
                    const result = await window.firebaseUserManagement.getAllUsers();
                    console.log('Firebase getAllUsers result:', result);
                    return result.success ? result.users : [];
                } catch (error) {
                    console.error('Error in loadUsers:', error);
                    return [];
                }
            }
            console.log('Firebase not available, returning empty array');
            return [];
        }
        
        async function saveUser(userData){
            if (window.firebaseUserManagement) {
                const result = await window.firebaseUserManagement.createUser(userData);
                return result;
            }
            return { success: false, error: 'Firebase not available' };
        }
        
        async function updateUser(username, updateData){
            if (window.firebaseUserManagement) {
                const result = await window.firebaseUserManagement.updateUser(username, updateData);
                return result;
            }
            return { success: false, error: 'Firebase not available' };
        }
        
        async function deleteUser(username){
            if (window.firebaseUserManagement) {
                const result = await window.firebaseUserManagement.deleteUser(username);
                return result;
            }
            return { success: false, error: 'Firebase not available' };
        }
        
        async function render(){
            var tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">Loading users...</td></tr>';
            
            try {
                console.log('Loading users from Firebase...');
                var users = await loadUsers();
                console.log('Loaded users:', users);
                tbody.innerHTML = '';
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No users found</td></tr>';
                    console.log('No users found in Firebase');
                    return;
                }
                
                users.forEach(function(u, idx){
                    var tr = document.createElement('tr');
                    var courseStatuses = getCourseStatuses(u);
                    tr.innerHTML = '<td>'+u.username+'</td>'+
                                   '<td>'+u.password+'</td>'+
                                   '<td>'+getCourseStatusBadge(courseStatuses['math-est-1'])+'</td>'+
                                   '<td>'+getCourseStatusBadge(courseStatuses['math-est-2'])+'</td>'+
                                   '<td>'+getCourseStatusBadge(courseStatuses['english-est-1'])+'</td>'+
                                   '<td>'+getCourseStatusBadge(courseStatuses['biology-est-1'])+'</td>'+
                                   '<td>'+getCourseStatusBadge(courseStatuses['biology-est-2'])+'</td>'+
                                   '<td>'+getCourseStatusBadge(courseStatuses['chemistry-est-2'])+'</td>'+
                                   '<td><button class="btn btn-sm btn-outline-danger" data-del="'+u.username+'">Delete</button></td>';
                    tbody.appendChild(tr);
                });
                console.log('Rendered', users.length, 'users in the table');
                await updateUserSelects();
                setupTableEventListeners(); // Re-setup event listeners after rendering
            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading users: ' + error.message + '</td></tr>';
            }
        }
        
        function setAdminLoggedIn(flag){ localStorage.setItem(adminKey, flag ? '1' : ''); }
        function isAdmin(){ return localStorage.getItem(adminKey) === '1'; }
        
        // Course-specific activation functions
        var COURSES = {
            'math-est-1': 'Math Course EST 1',
            'math-est-2': 'Math Course EST 2',
            'english-est-1': 'English Course EST 1',
            'biology-est-1': 'Biology Course EST 1',
            'biology-est-2': 'Biology Course EST 2',
            'chemistry-est-2': 'Chemistry Course EST 2'
        };
        
        function getCourseStatuses(user) {
            if (window.firebaseUserManagement) {
                return window.firebaseUserManagement.getCourseStatuses(user);
            }
            // Fallback to local calculation
            var statuses = {};
            Object.keys(COURSES).forEach(function(courseId) {
                statuses[courseId] = getCourseActivationStatus(user, courseId);
            });
            return statuses;
        }
        
        function getCourseActivationStatus(user, courseId) {
            if (window.firebaseUserManagement) {
                return window.firebaseUserManagement.getCourseActivationStatus(user, courseId);
            }
            // Fallback to local calculation
            if (!user.courseActivations || !user.courseActivations[courseId]) {
                return { active: false, daysLeft: 0, expires: null };
            }
            var now = new Date();
            var expires = new Date(user.courseActivations[courseId]);
            var daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
            return { active: daysLeft > 0, daysLeft: daysLeft, expires: expires };
        }
        
        function getCourseStatusBadge(status) {
            if (window.firebaseUserManagement) {
                return window.firebaseUserManagement.getCourseStatusBadge(status);
            }
            // Fallback to local calculation
            if (status.active) {
                return '<span class="badge badge-success" title="' + status.daysLeft + ' days left">Active</span>';
            } else if (status.expires) {
                return '<span class="badge badge-danger" title="Expired">Expired</span>';
            } else {
                return '<span class="badge badge-secondary">Inactive</span>';
            }
        }
        
        
        async function activateUserForCourse(username, courseId, days) {
            if (window.firebaseUserManagement) {
                const result = await window.firebaseUserManagement.activateCourseAccess(username, courseId, days);
                return result.success;
            }
            
            // Fallback to local storage (for backward compatibility)
            var users = await loadUsers();
            var user = users.find(function(u) { return u.username === username; });
            if (user) {
                if (!user.courseActivations) {
                    user.courseActivations = {};
                }
                var now = new Date();
                var expires = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
                user.courseActivations[courseId] = expires.toISOString();
                // Note: This fallback won't work with Firebase, but kept for compatibility
                return true;
            }
            return false;
        }
        
        
        async function updateUserSelects() {
            var select = document.getElementById('activateUser');
            if (select) {
                select.innerHTML = '<option value="">Loading users...</option>';
                try {
                    var users = await loadUsers();
                    select.innerHTML = '<option value="">Choose a user...</option>';
                    users.forEach(function(user) {
                        var option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading users for select:', error);
                    select.innerHTML = '<option value="">Error loading users</option>';
                }
            }
        }
        
        // Global function to check if user has access to a specific course
        window.checkCourseAccess = async function(username, courseId) {
            try {
                var users = await loadUsers();
                var user = users.find(function(u) { return u.username === username; });
                if (!user) return false;
                return getCourseActivationStatus(user, courseId).active;
            } catch (error) {
                console.error('Error checking course access:', error);
                return false;
            }
        };

        // Global function to get user course activation info
        window.getUserCourseActivationInfo = async function(username, courseId) {
            try {
                var users = await loadUsers();
                var user = users.find(function(u) { return u.username === username; });
                if (!user) return null;
                return getCourseActivationStatus(user, courseId);
            } catch (error) {
                console.error('Error getting user course activation info:', error);
                return null;
            }
        };

        // Global function to get all course activations for a user
        window.getUserAllCourseActivations = async function(username) {
            try {
                var users = await loadUsers();
                var user = users.find(function(u) { return u.username === username; });
                if (!user) return null;
                return getCourseStatuses(user);
            } catch (error) {
                console.error('Error getting user course activations:', error);
                return null;
            }
        };

        async function showPanel(){
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminPanel').style.display = '';
            await render();
            await updateUserSelects();
            setupTableEventListeners(); // Setup event listeners when panel is shown
        }
        function showLogin(){
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminLogin').style.display = '';
        }

        document.getElementById('adminLoginForm').addEventListener('submit', function(e){
            e.preventDefault();
            var u = document.getElementById('adminUser').value.trim();
            var p = document.getElementById('adminPass').value.trim();
            if(u === ADMIN_USER && p === ADMIN_PASS){
                setAdminLoggedIn(true);
                document.getElementById('adminLoginError').style.display = 'none';
                showPanel();
            } else {
                var err = document.getElementById('adminLoginError');
                err.textContent = 'Invalid admin credentials';
                err.style.display = '';
            }
        });

        document.getElementById('logoutAdmin').addEventListener('click', function(){
            setAdminLoggedIn(false);
            showLogin();
        });

        document.getElementById('userForm').addEventListener('submit', async function(e){
            e.preventDefault();
            var name = document.getElementById('uName').value.trim();
            var pass = document.getElementById('uPass').value.trim();
            var msg = document.getElementById('userFormMsg');
            
            if(!name || !pass){ 
                msg.textContent = 'Username and password required'; 
                msg.style.display=''; 
                return; 
            }
            
            try {
                // Check if user exists
                var users = await loadUsers();
                var existing = users.find(function(u){ return u.username.toLowerCase() === name.toLowerCase(); });
                
                if(existing){
                    // Update existing user
                    var result = await updateUser(name, { password: pass });
                    if (result.success) {
                        msg.innerHTML = '<div class="alert alert-success">User updated successfully!</div>';
                        msg.style.display='';
                    } else {
                        msg.innerHTML = '<div class="alert alert-danger">Failed to update user: ' + result.error + '</div>';
                        msg.style.display='';
                    }
                } else {
                    // Create new user
                    var result = await saveUser({username: name, password: pass});
                    if (result.success) {
                        msg.innerHTML = '<div class="alert alert-success">User created successfully!</div>';
                        msg.style.display='';
                    } else {
                        msg.innerHTML = '<div class="alert alert-danger">Failed to create user: ' + result.error + '</div>';
                        msg.style.display='';
                    }
                }
                
                document.getElementById('uName').value='';
                document.getElementById('uPass').value='';
                await render();
                
                // Hide message after 3 seconds
                setTimeout(function() {
                    msg.style.display='none';
                }, 3000);
                
            } catch (error) {
                console.error('Error handling user form:', error);
                msg.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                msg.style.display='';
            }
        });

        // Course-specific activation form
        document.getElementById('courseActivationForm').addEventListener('submit', async function(e){
            e.preventDefault();
            var username = document.getElementById('activateUser').value.trim();
            var courseId = document.getElementById('activateCourse').value.trim();
            var days = parseInt(document.getElementById('activationDays').value);
            var msg = document.getElementById('activationMsg');
            
            if(!username || !courseId || !days || days < 1){
                msg.innerHTML = '<div class="alert alert-danger">Please select a user, course, and enter valid days (1-365)</div>';
                msg.style.display = '';
                return;
            }
            
            try {
                var success = await activateUserForCourse(username, courseId, days);
                if(success){
                    var courseName = COURSES[courseId];
                    msg.innerHTML = '<div class="alert alert-success">User ' + username + ' activated for ' + courseName + ' (' + days + ' days)</div>';
                    msg.style.display = '';
                    document.getElementById('courseActivationForm').reset();
                    document.getElementById('activationDays').value = '30';
                    await render();
                } else {
                    msg.innerHTML = '<div class="alert alert-danger">Failed to activate user. User may not exist.</div>';
                    msg.style.display = '';
                }
                
                // Hide message after 5 seconds
                setTimeout(function() {
                    msg.style.display='none';
                }, 5000);
                
            } catch (error) {
                console.error('Error activating course access:', error);
                msg.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                msg.style.display = '';
            }
        });
        

        // Set up event delegation for the users table
        function setupTableEventListeners() {
            // Use document-level event delegation for better reliability
            document.removeEventListener('click', handleTableClick);
            document.addEventListener('click', handleTableClick);
        }
        
        async function handleTableClick(e) {
            // Only handle clicks within the users table
            if (!e.target.closest('#usersTable tbody')) {
                return;
            }
            
            var username = e.target.getAttribute('data-del');
            
            if(username !== null){
                if (confirm('Are you sure you want to delete user "' + username + '"?')) {
                    try {
                        var result = await deleteUser(username);
                        if (result.success) {
                            alert('User deleted successfully!');
                            await render();
                        } else {
                            alert('Failed to delete user: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        alert('Error deleting user: ' + error.message);
                    }
                }
            }
        }

        // Video Management Functions
        function setupVideoManagement() {
            // Video management form submission
            document.getElementById('videoManagementForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const courseId = document.getElementById('videoCourse').value;
                const videoKey = document.getElementById('videoKey').value;
                const videoUrl = document.getElementById('videoUrl').value;
                const msg = document.getElementById('videoMsg');
                
                if (!courseId || !videoKey || !videoUrl) {
                    msg.innerHTML = '<div class="alert alert-warning">Please fill in all fields</div>';
                    msg.style.display = '';
                    return;
                }
                
                // Validate Google Drive URL format
                if (!videoUrl.includes('drive.google.com/file/d/') || !videoUrl.includes('/preview')) {
                    msg.innerHTML = '<div class="alert alert-warning">Please use a valid Google Drive preview URL</div>';
                    msg.style.display = '';
                    return;
                }
                
                try {
                    if (window.firebaseCourseAccess) {
                        const success = await window.firebaseCourseAccess.updateSingleVideoUrl(courseId, videoKey, videoUrl);
                        if (success) {
                            msg.innerHTML = '<div class="alert alert-success">Video URL updated successfully!</div>';
                            msg.style.display = '';
                            document.getElementById('videoManagementForm').reset();
                            // Refresh the video list if it's currently displayed
                            if (document.getElementById('videoList').style.display !== 'none') {
                                loadCourseVideos(courseId);
                            }
                        } else {
                            msg.innerHTML = '<div class="alert alert-danger">Failed to update video URL</div>';
                            msg.style.display = '';
                        }
                    } else {
                        msg.innerHTML = '<div class="alert alert-danger">Firebase not available</div>';
                        msg.style.display = '';
                    }
                } catch (error) {
                    console.error('Error updating video:', error);
                    msg.innerHTML = '<div class="alert alert-danger">Error updating video URL</div>';
                    msg.style.display = '';
                }
            });
            
            // Load videos button
            document.getElementById('loadVideosBtn').addEventListener('click', function() {
                const courseId = document.getElementById('videoCourse').value;
                if (courseId) {
                    loadCourseVideos(courseId);
                } else {
                    alert('Please select a course first');
                }
            });
        }
        
        async function loadCourseVideos(courseId) {
            try {
                if (window.firebaseCourseAccess) {
                    const videoUrls = await window.firebaseCourseAccess.getVideoUrls(courseId);
                    const courseMetadata = await window.firebaseCourseAccess.getCourseMetadata(courseId);
                    
                    // Update course name display
                    document.getElementById('currentCourseName').textContent = courseMetadata.title;
                    
                    // Clear existing table rows
                    const tbody = document.querySelector('#videosTable tbody');
                    tbody.innerHTML = '';
                    
                    // Add video rows
                    Object.entries(videoUrls).forEach(([key, url]) => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${key}</td>
                            <td><a href="${url}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;">${url}</a></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editVideo('${key}', '${url}')">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteVideo('${key}')">Delete</button>
                            </td>
                        `;
                    });
                    
                    // Show the video list
                    document.getElementById('videoList').style.display = 'block';
                } else {
                    alert('Firebase not available');
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                alert('Error loading videos');
            }
        }
        
        // Edit video function
        window.editVideo = function(videoKey, currentUrl) {
            document.getElementById('videoKey').value = videoKey;
            document.getElementById('videoUrl').value = currentUrl;
            document.getElementById('videoKey').readOnly = true; // Prevent changing the key
        };
        
        // Delete video function
        window.deleteVideo = async function(videoKey) {
            if (!confirm('Are you sure you want to delete this video?')) return;
            
            const courseId = document.getElementById('videoCourse').value;
            const msg = document.getElementById('videoMsg');
            
            try {
                if (window.firebaseCourseAccess) {
                    // Get current videos
                    const videoUrls = await window.firebaseCourseAccess.getVideoUrls(courseId);
                    // Remove the video
                    delete videoUrls[videoKey];
                    // Update the entire collection
                    const success = await window.firebaseCourseAccess.updateVideoUrls(courseId, videoUrls);
                    
                    if (success) {
                        msg.innerHTML = '<div class="alert alert-success">Video deleted successfully!</div>';
                        msg.style.display = '';
                        loadCourseVideos(courseId); // Refresh the list
                    } else {
                        msg.innerHTML = '<div class="alert alert-danger">Failed to delete video</div>';
                        msg.style.display = '';
                    }
                }
            } catch (error) {
                console.error('Error deleting video:', error);
                msg.innerHTML = '<div class="alert alert-danger">Error deleting video</div>';
                msg.style.display = '';
            }
        };

        // Initialize video management when admin panel is shown
        const originalShowPanel = showPanel;
        window.showPanel = function() {
            originalShowPanel();
            setupVideoManagement();
        };

        // Initialize admin panel
        console.log('Initializing admin panel...');
        console.log('Is admin logged in:', isAdmin());
        if(isAdmin()) {
            console.log('Admin is logged in, showing panel...');
            showPanel();
        } else {
            console.log('Admin not logged in, showing login...');
            showLogin();
        }
    })();
    </script>
</body>
</html>
