<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase User Management Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .course-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        .status-active {
            background-color: #28a745;
            color: white;
        }
        .status-inactive {
            background-color: #6c757d;
            color: white;
        }
        .status-expired {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Firebase User Management Test</h1>
        <p>This page tests the complete Firebase user management system including CRUD operations and course access management.</p>
        
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="testResults"></div>
    </div>

    <div class="test-container">
        <h2>User Management Operations</h2>
        
        <div class="form-group">
            <label for="testUsername">Username:</label>
            <input type="text" id="testUsername" placeholder="Enter username">
        </div>
        
        <div class="form-group">
            <label for="testPassword">Password:</label>
            <input type="text" id="testPassword" placeholder="Enter password">
        </div>
        
        <div class="form-group">
            <label for="testEmail">Email (optional):</label>
            <input type="email" id="testEmail" placeholder="Enter email">
        </div>
        
        <button onclick="createTestUser()">Create User</button>
        <button onclick="getAllUsers()">Load All Users</button>
        <button onclick="deleteTestUser()">Delete User</button>
        
        <div id="userResults"></div>
        
        <div class="user-list" id="userList">
            <p>Click "Load All Users" to see the user list</p>
        </div>
    </div>

    <div class="test-container">
        <h2>Course Access Management</h2>
        
        <div class="form-group">
            <label for="courseUsername">Username:</label>
            <input type="text" id="courseUsername" placeholder="Enter username">
        </div>
        
        <div class="form-group">
            <label for="courseSelect">Course:</label>
            <select id="courseSelect">
                <option value="math-est-1">Math Course EST 1</option>
                <option value="math-est-2">Math Course EST 2</option>
                <option value="english-est-1">English Course EST 1</option>
                <option value="biology-est-1">Biology Course EST 1</option>
                <option value="biology-est-2">Biology Course EST 2</option>
                <option value="chemistry-est-2">Chemistry Course EST 2</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="courseDays">Duration (Days):</label>
            <input type="number" id="courseDays" value="30" min="1" max="365">
        </div>
        
        <button onclick="activateCourseAccess()">Activate Course Access</button>
        <button onclick="checkCourseAccess()">Check Course Access</button>
        <button onclick="deactivateCourseAccess()">Deactivate Course Access</button>
        
        <div id="courseResults"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration and User Management -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-user-management.js"></script>

    <script>
        function addResult(message, type = 'info', container = 'testResults') {
            const resultsDiv = document.getElementById(container);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('userResults').innerHTML = '';
            document.getElementById('courseResults').innerHTML = '';
        }

        async function testFirebaseSDK() {
            addResult('Testing Firebase SDK availability...', 'info');
            
            if (typeof firebase === 'undefined') {
                addResult('❌ Firebase SDK not loaded', 'error');
                return false;
            }
            
            addResult('✅ Firebase SDK loaded successfully', 'success');
            return true;
        }

        async function testFirebaseConfig() {
            addResult('Testing Firebase configuration...', 'info');
            
            try {
                if (!window.firebaseDB || !window.firebaseAuth) {
                    addResult('❌ Firebase not initialized properly', 'error');
                    return false;
                }
                
                addResult('✅ Firebase initialized successfully', 'success');
                addResult(`Project ID: ${firebase.app().options.projectId}`, 'info');
                return true;
            } catch (error) {
                addResult(`❌ Firebase initialization error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testUserManagement() {
            addResult('Testing User Management functionality...', 'info');
            
            try {
                if (!window.firebaseUserManagement) {
                    addResult('❌ Firebase User Management not available', 'error');
                    return false;
                }
                
                // Test getting users
                const result = await window.firebaseUserManagement.getAllUsers();
                if (result.success) {
                    addResult(`✅ User Management working - Found ${result.users.length} users`, 'success');
                    return true;
                } else {
                    addResult(`❌ User Management error: ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                addResult(`❌ User Management error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testWritePermission() {
            addResult('Testing write permissions...', 'info');
            
            try {
                // Try to write a test document
                await window.firebaseDB.collection('test').doc('write-test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true
                });
                
                addResult('✅ Write permissions working', 'success');
                return true;
            } catch (error) {
                addResult(`❌ Write permission error: ${error.message}`, 'error');
                return false;
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('Starting Firebase User Management tests...', 'info');
            
            const tests = [
                testFirebaseSDK,
                testFirebaseConfig,
                testUserManagement,
                testWritePermission
            ];
            
            let passed = 0;
            let total = tests.length;
            
            for (const test of tests) {
                try {
                    const result = await test();
                    if (result) passed++;
                } catch (error) {
                    addResult(`❌ Test error: ${error.message}`, 'error');
                }
            }
            
            addResult(`\nTest Summary: ${passed}/${total} tests passed`, passed === total ? 'success' : 'error');
            
            if (passed === total) {
                addResult('🎉 All Firebase User Management tests passed! Your system is ready.', 'success');
            } else {
                addResult('⚠️ Some tests failed. Check the error messages above for details.', 'error');
            }
        }

        async function createTestUser() {
            const username = document.getElementById('testUsername').value.trim();
            const password = document.getElementById('testPassword').value.trim();
            const email = document.getElementById('testEmail').value.trim();
            
            if (!username || !password) {
                addResult('Please enter username and password', 'error', 'userResults');
                return;
            }
            
            try {
                const userData = {
                    username: username,
                    password: password,
                    email: email || '',
                    fullName: `Test User ${username}`,
                    role: 'student'
                };
                
                const result = await window.firebaseUserManagement.createUser(userData);
                if (result.success) {
                    addResult(`✅ User "${username}" created successfully!`, 'success', 'userResults');
                    document.getElementById('testUsername').value = '';
                    document.getElementById('testPassword').value = '';
                    document.getElementById('testEmail').value = '';
                    getAllUsers(); // Refresh the user list
                } else {
                    addResult(`❌ Failed to create user: ${result.error}`, 'error', 'userResults');
                }
            } catch (error) {
                addResult(`❌ Error creating user: ${error.message}`, 'error', 'userResults');
            }
        }

        async function getAllUsers() {
            try {
                const result = await window.firebaseUserManagement.getAllUsers();
                if (result.success) {
                    displayUsers(result.users);
                    addResult(`✅ Loaded ${result.users.length} users`, 'success', 'userResults');
                } else {
                    addResult(`❌ Failed to load users: ${result.error}`, 'error', 'userResults');
                }
            } catch (error) {
                addResult(`❌ Error loading users: ${error.message}`, 'error', 'userResults');
            }
        }

        function displayUsers(users) {
            const userList = document.getElementById('userList');
            if (users.length === 0) {
                userList.innerHTML = '<p>No users found</p>';
                return;
            }
            
            userList.innerHTML = '';
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                const courseStatuses = window.firebaseUserManagement.getCourseStatuses(user);
                const statusHtml = Object.entries(courseStatuses).map(([courseId, status]) => {
                    let statusClass = 'status-inactive';
                    if (status.active) statusClass = 'status-active';
                    else if (status.expires) statusClass = 'status-expired';
                    
                    return `<span class="course-status ${statusClass}">${courseId}</span>`;
                }).join('');
                
                userDiv.innerHTML = `
                    <div>
                        <strong>${user.username}</strong><br>
                        <small>Email: ${user.email || 'N/A'} | Role: ${user.role || 'student'}</small><br>
                        ${statusHtml}
                    </div>
                    <button onclick="deleteUser('${user.username}')" style="background-color: #dc3545;">Delete</button>
                `;
                
                userList.appendChild(userDiv);
            });
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }
            
            try {
                const result = await window.firebaseUserManagement.deleteUser(username);
                if (result.success) {
                    addResult(`✅ User "${username}" deleted successfully!`, 'success', 'userResults');
                    getAllUsers(); // Refresh the user list
                } else {
                    addResult(`❌ Failed to delete user: ${result.error}`, 'error', 'userResults');
                }
            } catch (error) {
                addResult(`❌ Error deleting user: ${error.message}`, 'error', 'userResults');
            }
        }

        async function deleteTestUser() {
            const username = document.getElementById('testUsername').value.trim();
            if (!username) {
                addResult('Please enter username to delete', 'error', 'userResults');
                return;
            }
            
            await deleteUser(username);
        }

        async function activateCourseAccess() {
            const username = document.getElementById('courseUsername').value.trim();
            const courseId = document.getElementById('courseSelect').value;
            const days = parseInt(document.getElementById('courseDays').value);
            
            if (!username || !courseId || !days) {
                addResult('Please fill in all fields', 'error', 'courseResults');
                return;
            }
            
            try {
                const result = await window.firebaseUserManagement.activateCourseAccess(username, courseId, days);
                if (result.success) {
                    addResult(`✅ Course access activated for "${username}" in "${courseId}" for ${days} days`, 'success', 'courseResults');
                    getAllUsers(); // Refresh the user list
                } else {
                    addResult(`❌ Failed to activate course access: ${result.error}`, 'error', 'courseResults');
                }
            } catch (error) {
                addResult(`❌ Error activating course access: ${error.message}`, 'error', 'courseResults');
            }
        }

        async function checkCourseAccess() {
            const username = document.getElementById('courseUsername').value.trim();
            const courseId = document.getElementById('courseSelect').value;
            
            if (!username || !courseId) {
                addResult('Please enter username and select course', 'error', 'courseResults');
                return;
            }
            
            try {
                const result = await window.firebaseUserManagement.getUser(username);
                if (result.success) {
                    const status = window.firebaseUserManagement.getCourseActivationStatus(result.user, courseId);
                    if (status.active) {
                        addResult(`✅ User "${username}" has ACTIVE access to "${courseId}" (${status.daysLeft} days left)`, 'success', 'courseResults');
                    } else if (status.expires) {
                        addResult(`❌ User "${username}" has EXPIRED access to "${courseId}"`, 'error', 'courseResults');
                    } else {
                        addResult(`❌ User "${username}" has NO access to "${courseId}"`, 'error', 'courseResults');
                    }
                } else {
                    addResult(`❌ User not found: ${result.error}`, 'error', 'courseResults');
                }
            } catch (error) {
                addResult(`❌ Error checking course access: ${error.message}`, 'error', 'courseResults');
            }
        }

        async function deactivateCourseAccess() {
            const username = document.getElementById('courseUsername').value.trim();
            const courseId = document.getElementById('courseSelect').value;
            
            if (!username || !courseId) {
                addResult('Please enter username and select course', 'error', 'courseResults');
                return;
            }
            
            try {
                const result = await window.firebaseUserManagement.deactivateCourseAccess(username, courseId);
                if (result.success) {
                    addResult(`✅ Course access deactivated for "${username}" in "${courseId}"`, 'success', 'courseResults');
                    getAllUsers(); // Refresh the user list
                } else {
                    addResult(`❌ Failed to deactivate course access: ${result.error}`, 'error', 'courseResults');
                }
            } catch (error) {
                addResult(`❌ Error deactivating course access: ${error.message}`, 'error', 'courseResults');
            }
        }

        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addResult('Page loaded. Click "Run All Tests" to check Firebase User Management system.', 'info');
        });
    </script>
</body>
</html>
